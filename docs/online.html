<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Online:TopSecrets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Online:TopSecrets (c) Bok Consulting Pty Ltd 2024" />
    <meta name="author" content="BokkyPooBah" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@BokkyPooBah" />
    <meta name="twitter:creator" content="@BokkyPooBah" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue-icons.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/app.css" />
    <script src="js/vue.js"></script>
    <script src="js/bootstrap-vue.min.js"></script>
    <script src="js/bootstrap-vue-icons.min.js"></script>
    <script src="js/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <script src="js/moment.min.js"></script>
    <script src="globals.js"></script>
    <script src="chains.js"></script>
    <script src="deploymentData.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="mask-icon" href="images/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="images/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body>
    <div id="app">
      <b-container fluid class="m-0 p-0">
        <b-navbar toggleable="sm" variant="light" class="mx-1 my-0 p-0">
          <b-navbar-brand to="https://bokkypoobah.github.io/ApprovalTool/" variant="primary">
            <b-avatar rounded variant="light" size="3.0rem" src="images/topsecrets.svg" v-b-popover.hover.bottom="'gm'" class="ml-0"></b-avatar>
            <em v-b-popover.hover.bottom="'gm gm gm'">Online:TopSecrets</em>
          </b-navbar-brand>
          <b-navbar-nav class="ml-auto">
            <b-nav-item size="sm" @click="settings.tabIndex = 0; saveSettings();" :active="settings.tabIndex == 0" active-class="active" v-b-popover.hover="'Maintain Addresses'">Addresses</b-nav-item>
            <b-nav-item size="sm" @click="settings.tabIndex = 1; saveSettings();" :active="settings.tabIndex == 1" active-class="active" v-b-popover.hover="'Prepare transaction for signing and submit signed transaction'">Transaction</b-nav-item>
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 1; saveSettings();" :active="settings.tabIndex == 1" active-class="active" v-b-popover.hover="'Events'">Events</b-nav-item> -->
            <!-- <b-nav-item size="sm" @click="settings.tabIndex = 2; saveSettings();" :active="settings.tabIndex == 2" active-class="active" v-b-popover.hover="'Accounts'">Accounts</b-nav-item> -->
            <b-avatar v-if="coinbase && coinbase != nameOrAddress(coinbase)" rounded variant="light" size="3.0rem" :src="'https://metadata.ens.domains/mainnet/avatar/' + nameOrAddress(coinbase, 100)" v-b-popover.hover="'Your ENS avatar if set'"></b-avatar>
            <b-button size="sm" variant="outline-primary" class="ml-1" @click="connectToWeb3(); processNewBlock(0);" v-b-popover.hover="'Your currently connected wallet'">{{ coinbase ? nameOrAddress(coinbase, 16) : 'Connect' }}</b-button>
          </b-navbar-nav>
        </b-navbar>

        <b-card no-body class="p-0 mt-0" style="min-height: 666px;">
          <b-alert size="sm" dismissible variant="warning" show class="m-1 my-0">
            Warning: This is experimental unaudited work-in-progress software.
          </b-alert>
          <b-alert v-if="false" size="sm" dismissible variant="warning" show class="m-1 my-0">
            Warning: This is experimental unaudited software. Please check your transaction data carefully before signing
          </b-alert>
          <b-card class="m-2 p-1" header-class="warningheader" header="Welcome" v-if="!coinbase">
            <b-card-text>
              Please install the MetaMask extension and connect to the Ethereum Mainnet or an EVM compatible chain. Then refresh this page, and click the [Connect] button on the top right.
            </b-card-text>
          </b-card>

          <!-- :MODALADDRESS -->
          <b-modal id="modal-address" hide-footer size="lg" body-bg-variant="light">
            <template #modal-title>
              {{ address.mode == 'add' ? 'New' : ''}} Address
            </template>
            <b-form-group label="Type:" label-for="address-type" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-form-select size="sm" id="address-type" v-model="address.type" :options="addressTypeOptions" style="max-width: 300px;"></b-form-select>
            </b-form-group>
            <!-- <b-form-group label="Private Key:" label-for="newwalletfromprivatekey-privatekey" label-size="sm" label-cols-sm="2" label-align-sm="right" :state="!newWalletFromPrivateKey.privateKeyError" :invalid-feedback="newWalletFromPrivateKey.privateKeyError" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" id="newwalletfromprivatekey-privatekey" v-model="newWalletFromPrivateKey.privateKey" @change="newWalletFromPrivateKeyRecompute();" placeholder="Type/paste your private key here or click [Generate New]" style="max-width: 600px;"></b-form-input>
            </b-form-group> -->
            <!-- <b-form-group label="" label-for="newwalletfromprivatekey-generaterandom" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-button size="sm" id="newwalletfromprivatekey-generaterandom" @click="newWalletFromPrivateKeyGenerateRandom()" variant="primary">Generate Random</b-button>
            </b-form-group> -->
            <b-form-group label="Address:" label-for="address-address" label-size="sm" label-cols-sm="2" label-align-sm="right" :state="!address.addressError" :invalid-feedback="address.addressError" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" id="address-address" v-model.trim="address.address" @change="newWalletRecompute();" placeholder="Type/paste your ETH address here" style="max-width: 400px;"></b-form-input>
            </b-form-group>
            <b-form-group v-if="['wallet', 'address'].includes(address.type)" label="ENS Name:" label-for="address-ensname" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" readonly id="address-ensname" v-model.trim="address.ensName" style="max-width: 300px;"></b-form-input>
            </b-form-group>
            <b-form-group v-if="['wallet', 'address'].includes(address.type)" label="" label-for="address-retrieveens" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-button size="sm" :disabled="address.addressError || !address.address || chainId != 1" id="address-retrieveens" @click="addressRetrieveENS()" variant="primary">Retrieve ENS</b-button>
            </b-form-group>
            <b-form-group label="Name:" label-for="address-name" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" id="address-name" v-model.trim="address.name" placeholder="Optional" style="max-width: 300px;"></b-form-input>
            </b-form-group>
            <b-form-group v-if="['erc20', 'erc721'].includes(address.type)" label="Symbol:" label-for="address-symbol" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" id="address-symbol" v-model.trim="address.symbol" placeholder="For token contracts" style="max-width: 300px;"></b-form-input>
            </b-form-group>
            <b-form-group v-if="address.type == 'erc20'" label="Decimals:" label-for="address-decimals" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-form-input type="text" size="sm" id="address-decimals" v-model.trim="address.decimals" placeholder="For ERC-20 token contracts" style="max-width: 300px;"></b-form-input>
            </b-form-group>
            <b-form-group v-if="['erc20', 'erc721'].includes(address.type)" label="" label-for="address-retrieve" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-button size="sm" id="address-retrieve" @click="addressRetrieveFromContract()" variant="primary">Retrieve From Contract</b-button>
            </b-form-group>
            <b-form-group label="Chains:" label-for="address-chains" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <div style="overflow-y:scroll; max-height:200px" class="mt-1 ml-2">
                <b-form-checkbox-group size="sm" stacked id="address-chains" v-model="address.chains" :options="chainsOptions" switches></b-form-checkbox-group>
              </div>
            </b-form-group>
            <b-form-group v-if="address.mode == 'add'" label="" label-for="address-add" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-button size="sm" :disabled="!address.type || !address.address" id="address-add" @click="addressAdd()" variant="primary">Add</b-button>
            </b-form-group>
            <b-form-group v-if="address.mode == 'vieworupdate'" label="" label-for="address-update" label-size="sm" label-cols-sm="2" label-align-sm="right" class="mx-0 my-1 p-0">
              <b-button size="sm" :disabled="!address.type || !address.address" id="address-update" @click="addressUpdate()" variant="primary">Update</b-button>
              <b-button size="sm" :disabled="!address.address" @click="addressDelete()" variant="warning">Delete</b-button>
            </b-form-group>
          </b-modal>

          <!-- :ADDRESSES -->
          <b-card v-if="settings.tabIndex == 0" class="m-0 p-0 border-0" body-class="m-1 p-0">
            <div class="d-flex flex-wrap m-0 p-0">
              <div class="mt-0 flex-grow-1">
              </div>
              <div class="mt-0 pr-1">
                <b-button size="sm" @click="showNewAddress" variant="link" v-b-popover.hover.bottom="'New Wallet'">
                  <b-icon-plus shift-v="+1" font-scale="1.0"></b-icon-plus>
                </b-button>
              </div>
              <!-- <div class="mt-0 pr-1">
                <b-dropdown size="sm" variant="link" v-b-popover.hover.bottom="'New Wallet'">
                  <template #button-content>
                    <b-icon-plus shift-v="+1" font-scale="1.0"></b-icon-plus>
                  </template>
                  <b-dropdown-item @click="showNewAddressFromMnemonic">New Wallet From Mnemonic</b-dropdown-item>
                  <b-dropdown-item @click="showNewAddressFromPrivateKey">New Wallet From Private Key</b-dropdown-item>
                  <b-dropdown-item @click="showNewAddressFromKeystore">New Wallet From JSON/UTC Keystore Private Key</b-dropdown-item>
                </b-dropdown>
              </div> -->
              <div class="mt-0 flex-grow-1">
              </div>
              <div class="mt-0 pl-1">
                <font size="-2" v-b-popover.hover.bottom="'# addresses'">{{ commify0(addresses.length) }}</font>
              </div>
              <div class="mt-0 pl-1">
                <b-pagination size="sm" v-model="settings.addressesTable.currentPage" @input="saveSettings" :total-rows="filteredSortedAddresses.length" :per-page="settings.addressesTable.pageSize" style="height: 0;"></b-pagination>
              </div>
              <div class="mt-0 pl-1">
                <b-form-select size="sm" v-model="settings.addressesTable.pageSize" :options="pageSizes" v-b-popover.hover.bottom="'Yeah. Page size'"></b-form-select>
              </div>
            </div>
            <b-table ref="addressesTable" small fixed striped responsive hover selectable select-mode="single" @row-selected='addressesRowSelected' :fields="addressesFields" :items="pagedFilteredSortedAddresses" show-empty empty-html="Add new wallets" head-variant="light" class="mx-0 my-1">
              <template #cell(number)="data">
                <font size="-1">
                  {{ parseInt(data.index) + ((settings.addressesTable.currentPage - 1) * settings.addressesTable.pageSize) + 1 }}
                </font>
              </template>
              <template #cell(type)="data">
                <b-badge pill variant="transparent" class="px-0">{{ addressTypeOptions.filter(e => e.value == data.item.type)[0].text }}</b-badge>
              </template>
            </b-table>
          </b-card>

          <!-- :ETH -->
          <b-card v-if="settings.tabIndex == 1" class="m-0 p-0 border-0" body-class="m-1 p-0">
            <b-card-group deck class="m-0 p-0">
              <!-- :PREPARE -->
              <b-card sub-title="Prepare Transaction" bg-variant="light" class="p-0 m-1" style="max-width: 900px;">
                <b-form-group label-cols-lg="2" label="Input" label-size="md" label-class="font-weight-bold pt-0" class="mb-0 mt-3">
                  <b-form-group label="Action:" label-for="prepare-action" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-form-select size="sm" id="prepare-action" v-model="prepare.action" :options="actionOptions" @change="prepareSimulate();" style="max-width: 300px;"></b-form-select>
                  </b-form-group>
                  <b-form-group v-if="['erc20transfer', 'erc721transfer'].includes(prepare.action)" label="Token:" label-for="prepare-token" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <template v-if="prepare.token.address" slot="description">
                      <b-link v-if="prepare.token.totalSupply && prepare.token.decimals" :href="explorer + '/token/' + prepare.token.address" target="_blank" v-b-popover.hover="'Total Supply. View in explorer'">
                        <font size="-2">{{ formatUnits(prepare.token.totalSupply, prepare.token.decimals) }}</font>
                      </b-link>
                      <b-badge button v-if="prepare.token.symbol" variant="muted" v-b-popover.hover="'symbol'">{{ prepare.token.symbol }}</b-badge>
                      <b-badge button v-if="prepare.token.decimals" variant="muted" v-b-popover.hover="'decimals'">{{ prepare.token.decimals }}</b-badge>
                    </template>
                    <b-form-select size="sm" :disabled="!prepare.action" id="prepare-token" v-model="prepare.token.address" :options="tokensOptions" @change="prepareSimulate();" v-b-popover.hover.bottom="'Select Token'"></b-form-select>
                  </b-form-group>
                  <b-form-group label="From:" label-for="prepare-from" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <template v-if="prepare.action && prepare.from.address" slot="description">
                      <b-link v-if="prepare.action == 'erc20transfer' && prepare.from.tokens && prepare.token.decimals" :href="explorer + '/token/' + prepare.token.address + '?a=' + prepare.from.address" target="_blank" v-b-popover.hover="prepare.token.symbol + '. View in explorer'">
                        <font size="-2">{{ formatUnits(prepare.from.tokens, prepare.token.decimals) }}</font>
                      </b-link>
                      <b-link :href="explorer + '/address/' + prepare.from.address" target="_blank" v-b-popover.hover="'ETH. View in explorer'"><font size="-2">{{ prepare.from.balance && formatETH(prepare.from.balance) || null }}</font></b-link>
                      <b-badge button variant="muted" v-b-popover.hover="'#transactions'">{{ prepare.from.transactionCount }}</b-badge>
                      <b-badge button v-if="prepare.from.ensName" variant="muted" v-b-popover.hover="'ENS name'">{{ prepare.from.ensName }}</b-badge>
                    </template>
                    <b-form-select size="sm" :disabled="!prepare.action" id="prepare-from" v-model="prepare.from.address" :options="walletsOptions" @change="prepareSimulate();" v-b-popover.hover.bottom="'Select Wallet'"></b-form-select>
                  </b-form-group>
                  <b-form-group label="To:" label-for="prepare-to" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <template v-if="prepare.action && prepare.to.address" slot="description">
                      <b-link v-if="prepare.action == 'erc20transfer' && prepare.to.tokens && prepare.token.decimals" :href="explorer + '/token/' + prepare.token.address + '?a=' + prepare.to.address" target="_blank" v-b-popover.hover="prepare.token.symbol + '. View in explorer'">
                        <font size="-2">{{ formatUnits(prepare.to.tokens, prepare.token.decimals) }}</font>
                      </b-link>
                      <b-link :href="explorer + '/address/' + prepare.to.address" target="_blank" v-b-popover.hover="'ETH. View in explorer'"><font size="-2">{{ prepare.to.balance && formatETH(prepare.to.balance) || null }}</font></b-link>
                      <b-badge button variant="muted" v-b-popover.hover="'#transactions'">{{ prepare.to.transactionCount }}</b-badge>
                      <b-badge button v-if="prepare.to.ensName" variant="muted" v-b-popover.hover="'ENS name'">{{ prepare.to.ensName }}</b-badge>
                    </template>
                    <b-form-select size="sm" :disabled="!prepare.action" id="prepare-to" v-model="prepare.to.address" :options="addressesOptions" @change="prepareSimulate();" v-b-popover.hover.bottom="'Select Address'"></b-form-select>
                  </b-form-group>
                  <b-form-group v-if="prepare.action == 'ethtransfer'" label="Amount:" label-for="prepare-amount" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" id="prepare-amount" v-model.trim="prepare.amount" @change="prepareSimulate();"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-form-select size="sm" :disabled="!prepare.action" v-model="prepare.amountUnit" :options="unitOptions" @change="prepareSimulate();"></b-form-select>
                      </div>
                    </div>
                  </b-form-group>
                  <b-form-group v-if="prepare.action == 'erc20transfer'" label="Tokens:" label-for="prepare-tokens" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" id="prepare-tokens" v-model.trim="prepare.tokens" @change="prepareSimulate();"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-badge button v-if="prepare.token.symbol" variant="muted" v-b-popover.hover="'symbol'">{{ prepare.token.symbol }}</b-badge>
                        <b-badge button v-if="prepare.token.decimals" variant="muted" v-b-popover.hover="'decimals'">{{ prepare.token.decimals }}</b-badge>
                        <!-- <b-form-select size="sm" :disabled="!prepare.action" v-model="prepare.amountUnit" :options="unitOptions" @change="prepareSimulate();"></b-form-select> -->
                      </div>
                    </div>
                  </b-form-group>
                </b-form-group>
                <b-form-group label-cols-lg="2" label="Network Parameters" label-size="md" label-class="font-weight-bold pt-0" class="mb-0 mt-2">
                  <b-form-group label="" label-for="prepare-simulate" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.error" :invalid-feedback="prepare.error" class="mx-0 my-1 p-0">
                    <b-button size="sm" id="prepare-simulate" @click="prepareSimulate()" variant="primary">Refresh</b-button>
                  </b-form-group>

                  <b-form-group label="Chain:" label-for="prepare-chain" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.chainIdError" :invalid-feedback="prepare.chainIdError" class="mx-0 my-1 p-0">
                    <template v-if="prepare.chainIdError" slot="invalid-feedback">
                      WARNING: <b-link size="sm" v-if="prepare.chainIdError" @click="prepare.chainId = chainId; prepareSimulate()" variant="link">Set to {{ chainsOptions.filter(e => e.value == chainId).length > 0 && chainsOptions.filter(e => e.value == chainId)[0].text }}</b-link>
                    </template>
                    <b-form-select size="sm" id="prepare-chain" v-model="prepare.chainId" :options="chainsOptionsWithSelect" @change="prepareSimulate();" style="max-width: 200px;"></b-form-select>
                  </b-form-group>

                  <b-form-group label="Nonce:" label-for="prepare-nonce" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.nonceError" :invalid-feedback="prepare.nonceError" class="mx-0 my-1 p-0">
                    <template v-if="prepare.nonceError" slot="invalid-feedback">
                      WARNING: <b-link size="sm" @click="prepare.nonce = prepare.from.transactionCount; prepareSimulate()" variant="link">Set to {{ prepare.from.transactionCount }}</b-link>
                    </template>
                    <b-form-input type="number" size="sm" id="prepare-nonce" v-model.trim="prepare.nonce" @change="prepareSimulate();" style="max-width: 150px;"></b-form-input>
                  </b-form-group>

                  <b-form-group label="Gas Limit:" label-for="prepare-gaslimit" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.gasLimitError" :invalid-feedback="prepare.gasLimitError" class="mx-0 my-1 p-0">
                    <template v-if="prepare.gasLimitError" slot="invalid-feedback">
                      WARNING: <b-link size="sm" @click="prepare.gasLimit = prepare.estimatedGas; prepareSimulate()" variant="link">Set to {{ prepare.estimatedGas }}</b-link>
                    </template>
                    <b-form-input type="number" size="sm" id="prepare-gaslimit" v-model.trim="prepare.gasLimit" @change="prepareSimulate();" style="max-width: 150px;"></b-form-input>
                  </b-form-group>

                  <b-form-group v-if="false" label="Estimated Gas:" label-for="prepare-estimatedgas" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <b-form-input type="text" size="sm" readonly id="prepare-estimatedgas" v-model.trim="prepare.estimatedGas" style="max-width: 150px;"></b-form-input>
                  </b-form-group>

                  <b-form-group v-if="false" label="Gas Price:" label-for="prepare-gasprice" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" readonly id="prepare-gasprice" :value="formatUnits(prepare.gasPrice, prepare.gasPriceUnit)"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-form-select size="sm" v-model="prepare.gasPriceUnit" :options="unitOptions" @change="prepareSimulate();" style="max-width: 300px;"></b-form-select>
                      </div>
                    </div>
                  </b-form-group>
                  <b-form-group v-if="false" label="Last Base Fee:" label-for="prepare-lastbasefeepergas" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" readonly id="prepare-lastbasefeepergas" :value="formatUnits(prepare.lastBaseFeePerGas, prepare.lastBaseFeePerGasUnit)"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-form-select size="sm" v-model="prepare.lastBaseFeePerGasUnit" :options="unitOptions" @change="prepareSimulate();" style="max-width: 300px;"></b-form-select>
                      </div>
                    </div>
                  </b-form-group>
                  <b-form-group label="Max Base Fee:" label-for="prepare-maxfeepergas" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.maxFeePerGasError" :invalid-feedback="prepare.maxFeePerGasError" class="mx-0 my-1 p-0">
                    <template slot="description">
                      <code>lastBaseFeePerGas</code>: <code>{{ formatUnits(feeData.lastBaseFeePerGas, prepare.gasUnit) }}</code>; <code>maxFeePerGas</code>: <code>{{ formatUnits(feeData.maxFeePerGas, prepare.gasUnit) }}</code>
                    </template>
                    <template v-if="prepare.maxFeePerGasError" slot="invalid-feedback">
                      WARNING: TODO {{ prepare.maxFeePerGasError }}
                      <!-- <b-link size="sm" @click="prepare.gasLimit = prepare.estimatedGas; prepareSimulate()" variant="link">Set to {{ prepare.estimatedGas }}</b-link> -->
                    </template>
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" id="prepare-maxfeepergas" v-model.trim="prepare.maxFeePerGas" @change="prepareSimulate();"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-form-select size="sm" v-model="prepare.gasUnit" :options="unitOptions" @change="prepareSimulate();" style="max-width: 300px;"></b-form-select>
                      </div>
                    </div>
                  </b-form-group>
                  <b-form-group label="Priority Fee:" label-for="prepare-maxpriorityfeepergas" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.maxPriorityFeePerGasError" :invalid-feedback="prepare.maxPriorityFeePerGasError" class="mx-0 my-1 p-0">
                    <template slot="description">
                      <code>maxPriorityFeePerGas</code>: <code>{{ formatUnits(feeData.maxPriorityFeePerGas, prepare.gasUnit) }}</code>
                    </template>
                    <template v-if="prepare.maxPriorityFeePerGasError" slot="invalid-feedback">
                      WARNING: TODO {{ prepare.maxPriorityFeePerGasError }}
                      <!-- <b-link size="sm" @click="prepare.gasLimit = prepare.estimatedGas; prepareSimulate()" variant="link">Set to {{ prepare.estimatedGas }}</b-link> -->
                    </template>
                    <div class="d-flex flex-wrap m-0 p-0">
                      <div class="mt-0 pr-1">
                        <b-form-input type="text" size="sm" id="prepare-maxpriorityfeepergas" v-model.trim="prepare.maxPriorityFeePerGas" @change="prepareSimulate();"></b-form-input>
                      </div>
                      <div class="mt-0 pr-1">
                        <b-form-select size="sm" disabled v-model="prepare.gasUnit" :options="unitOptions" @change="prepareSimulate();" style="max-width: 300px;"></b-form-select>
                      </div>
                    </div>
                  </b-form-group>
                </b-form-group>
              </b-card>

              <!-- :SUBMIT -->
              <b-card sub-title="Submit Transaction" bg-variant="light" class="p-0 m-1" style="max-width: 900px;">
                <b-form-group label="Signed Transaction:" label-for="submit-signedtx" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!submit.error" :invalid-feedback="submit.error" class="mx-0 my-2 p-0">
                  <b-form-textarea size="sm" id="submit-signedtx" v-model.trim="submit.signedTx" rows="5" @change="saveSettings(); submitCompare();" placeholder="Paste signed transaction here" style="max-width: 800px;"></b-form-textarea>
                </b-form-group>
                <b-form-group label="From:" label-for="submit-from" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="prepare.from == submit.from" invalid-feedback="different" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-from" :value="submit.from"></b-form-input>
                </b-form-group>
                <b-form-group label="To:" label-for="submit-to" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="prepare.to == submit.to" invalid-feedback="different" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-to" :value="submit.to"></b-form-input>
                </b-form-group>
                <b-form-group label="Amount:" label-for="submit-amount" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="prepare.amount == formatUnits(submit.amount, prepare.amountUnit)" invalid-feedback="different" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-amount" :value="formatUnits(submit.amount, prepare.amountUnit)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <!-- TODO: Check for differences below -->
                <b-form-group label="Data:" label-for="submit-data" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-data" :value="submit.data"></b-form-input>
                </b-form-group>
                <b-form-group label="Chain:" label-for="submit-chainid" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="submit.chainId == prepare.chainId" invalid-feedback="different" class="mx-0 my-1 p-0">
                  <b-form-select size="sm" disabled id="submit-chainid" v-model="submit.chainId" :options="chainsOptions" style="max-width: 200px;"></b-form-select>
                </b-form-group>
                <b-form-group label="Nonce:" label-for="submit-nonce" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="submit.nonce == prepare.nonce" invalid-feedback="different" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-nonce" :value="submit.nonce" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="Gas Limit:" label-for="submit-gaslimit" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="submit.gasLimit >= prepare.estimatedGas" invalid-feedback="Gas Limit < Estimated Gas" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-gaslimit" :value="submit.gasLimit" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="Type:" label-for="submit-type" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-select size="sm" disabled id="submit-type" v-model="submit.type" :options="transactionTypeOptions" style="max-width: 150px;"></b-form-select>
                </b-form-group>
                <b-form-group v-if="!submit.type" label="Gas Price:" label-for="submit-gasprice" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-gasprice" :value="formatUnits(submit.gasPrice, prepare.gasPriceUnit)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group v-if="submit.type == 2" label="Max Base Fee:" label-for="submit-maxbasefee" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-maxbasefee" :value="formatUnits(submit.maxFeePerGas, prepare.maxFeePerGasUnit)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group v-if="submit.type == 2" label="Priority Fee:" label-for="submit-priorityfee" label-size="sm" label-cols-sm="3" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="submit-priorityfee" :value="formatUnits(submit.maxPriorityFeePerGas, prepare.maxPriorityFeePerGasUnit)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="" label-for="submit-simulate" label-size="sm" label-cols-sm="3" label-align-sm="right" :state="!prepare.error" :invalid-feedback="prepare.error" class="mx-0 my-1 p-0">
                  <b-button size="sm" id="submit-simulate" @click="submitSimulate()" variant="primary">Check</b-button>
                  <b-button size="sm" @click="submitSend()" variant="warning">Send</b-button>
                </b-form-group>
              </b-card>

              <!-- :Gas -->
              <b-card v-if="false" sub-title="Latest Gas (gwei)" bg-variant="light" class="p-0 m-1" style="max-width: 400px;">
                <b-form-group label="Last Base Fee Per Gas:" label-for="gas-lastbasefeepergas" label-size="sm" label-cols-sm="6" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="gas-lastbasefeepergas" :value="formatGas(feeData.lastBaseFeePerGas)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="Max Fee Per Gas:" label-for="gas-maxfeepergas" label-size="sm" label-cols-sm="6" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="gas-maxfeepergas" :value="formatGas(feeData.maxFeePerGas)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="Max Priority Fee Per Gas:" label-for="gas-maxpriorityfeepergas" label-size="sm" label-cols-sm="6" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="gas-maxpriorityfeepergas" :value="formatGas(feeData.maxPriorityFeePerGas)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
                <b-form-group label="Gas Price:" label-for="gas-gasprice" label-size="sm" label-cols-sm="6" label-align-sm="right" class="mx-0 my-1 p-0">
                  <b-form-input type="text" size="sm" readonly id="gas-gasprice" :value="formatGas(feeData.gasPrice)" style="max-width: 150px;"></b-form-input>
                </b-form-group>
              </b-card>

            </b-card-group>
          </b-card>
        </b-card>

        <b-card no-header body-class="m-0 p-0" class="m-0 p-0 border-0">
          <div class="d-flex flex-wrap m-0 p-0">
            <div class="ml-0 mt-1 pl-1">
              <font v-if="connected" size="-2">
                <!-- <b-link v-if="coinbase" :href="'https://etherscan.io/address/' + coinbase" v-b-popover.hover.bottom="'Coinbase'" target="_blank">
                  {{ coinbase.substring(0, 10) }}
                </b-link> -->
                <b-link v-if="chainId" :href="'https://etherscan.io/'" v-b-popover.hover.bottom="'Network'" target="_blank">
                  {{ chains[chainId] && chains[chainId].name || ('ChainId: ' + chainId) }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="'Latest block'" target="_blank">
                  {{ '#' + commify0(blockNumber) }}
                </b-link>
                <b-link v-if="blockNumber" :href="'https://etherscan.io/block/' + blockNumber" v-b-popover.hover.bottom="formatTimestamp(timestamp)" target="_blank">
                  {{ formatTimeDiff(timestamp) }}
                </b-link>
              </font>
            </div>
            <div class="mt-0 flex-grow-1">
            </div>
            <div class="mt-0 pl-1 pr-1">
              gm, and enjoy! <i>Online:TopSecrets</i> &copy; Bok Consulting Pty Ltd 2024
            </div>
          </div>
        </b-card>
      </b-container>
    </div>

    <script>
      window.app = new Vue({
        el: '#app',
        // --- DATA ---
        data: {
          connected: false,
          chainId: null,
          coinbase: null,
          blockNumber: null,
          timestamp: null,
          feeData: {
            gasPrice: null,
            lastBaseFeePerGas: null,
            maxFeePerGas: null,
            maxPriorityFeePerGas: null,
          },

          forceRefresh: 0,

          address: {
            mode: null,
            type: null,
            address: null,
            addressError: null,
            ensName: null,
            name: null,
            symbol: null,
            decimals: null,
            chains: [],
          },

          prepare: {
            action: null,
            token: {
              address: null,
              name: null,
              symbol: null,
              decimals: null,
              totalSupply: null,
            },
            from: {
              address: null,
              ensName: null,
              transactionCount: null,
              balance: null,
              tokens: null,
            },
            to: {
              address: null,
              ensName: null,
              transactionCount: null,
              balance: null,
              tokens: null,
            },
            amount: null,
            amountUnit: "ether",
            tokens: null,
            // TODO: ERC-721 tokenId: null,
            // data: null,
            // signature: null,
            chainId: null,
            chainIdError: null,
            nonce: null,
            nonceError: null,
            estimatedGas: null,
            gasLimit: null,
            gasLimitError: null,
            transactionType: 2,
            gasPrice: null, // TODO: Delete
            lastBaseFeePerGas: null, // TODO: Delete
            maxFeePerGas: null,
            maxFeePerGasError: null,
            maxPriorityFeePerGas: null,
            maxPriorityFeePerGasError: null,
            gasUnit: "gwei",
            gasPriceUnit: "gwei", // TODO: Delete
            lastBaseFeePerGasUnit: "gwei", // TODO: Delete
            maxFeePerGasUnit: "gwei", // TODO: Delete
            maxPriorityFeePerGasUnit: "gwei", // TODO: Delete
            tx: {},
            error: null,
          },

          submit: {
            signedTx: null,
            decodedSignedTx: null,
            error: null,
            token: null,
            from: null,
            to: null,
            amount: null,
            data: null,
            chainId: null,
            nonce: null,
            gasLimit: null,
            type: null,
            gasPrice: null,
            maxFeePerGas: null,
            maxPriorityFeePerGas: null,
          },

          settings: {
            tabIndex: 0,

            addressesTable: {
              filter: null,
              currentPage: 1,
              pageSize: 10,
              sortOption: 'addressasc',
            },

            version: 0,
          },

          addresses: {},

          chains: {},

          addressTypeOptions: [
            { value: null, text: '(Select Type)' },
            { value: 'wallet', text: 'My Wallet' },
            { value: 'address', text: 'Address' },
            { value: 'erc20', text: 'ERC-20 Token Contract' },
            { value: 'erc721', text: 'ERC-721 Token Contract' },
            { value: 'contract', text: 'Contract' },
          ],

          actionOptions: [
            { value: null, text: '(Select Action)' },
            { value: 'ethtransfer', text: 'Transfer Ethers' },
            { value: 'erc20transfer', text: 'Transfer ERC-20 Tokens' },
            { value: 'erc721transfer', text: 'Transfer ERC-721 Token', disabled: true },
            // { value: 'sweepwallet', text: 'Sweep ETH To New Wallet', disabled: true }, // TODO: Type 1 with amount = balance - gasLimit * gasPrice
            // { value: 'deploycontract', text: 'Deploy Contract', disabled: true }, // TODO: `to` null; data with code
            // { value: 'writemessage', text: 'Write Message', disabled: true }, // TODO: `to` to own account, or destination; data with message
            // { value: 'erc20approve', text: 'ERC-20 approve', disabled: true },
            // { value: 'erc721setapprovalforall', text: 'ERC-721 setApprovalForAll', disabled: true },
          ],

          unitOptions: [
            { value: "ether", text: 'ETH' },
            { value: "gwei", text: 'Gwei' },
            { value: "wei", text: 'Wei' },
          ],

          transactionTypeOptions: [
            { value: null, text: 'null: Legacy', disabled: true },
            { value: 0, text: 'Type 0' },
            { value: 1, text: 'Type 1', disabled: true },
            { value: 2, text: 'Type 2' },
            { value: 3, text: 'Type 3', disabled: true },
          ],

          pageSizes: [
            { value: 5, text: '5' },
            { value: 10, text: '10' },
            { value: 25, text: '25' },
            { value: 50, text: '50' },
            { value: 100, text: '100' },
            { value: 500, text: '500' },
            { value: 1000, text: '1k' },
            { value: 2500, text: '2.5k' },
            { value: 10000, text: '10k' },
          ],

          // TODO: Delete
          accountTypeOptions: [
            { value: null, text: '(use default)' },
            { value: "eoa", text: 'EOA' },
            { value: "erc20", text: 'ERC-20' },
            { value: "erc721", text: 'ERC-721' },
            { value: "erc1155", text: 'ERC-1155' },
            { value: "ftexchange", text: 'FTExchange' },
            { value: "nftexchange", text: 'NFTExchange' },
            { value: "unknown", text: '(Unknown)' },
          ],
          decimalsOptions: [
            { value: null, text: '(use default)' },
            { value: "0", text: '0' },
            { value: "1", text: '1' },
            { value: "2", text: '2' },
            { value: "3", text: '3' },
            { value: "4", text: '4' },
            { value: "5", text: '5' },
            { value: "6", text: '6 (some)' },
            { value: "7", text: '7' },
            { value: "8", text: '8' },
            { value: "9", text: '9' },
            { value: "10", text: '10' },
            { value: "11", text: '11' },
            { value: "12", text: '12' },
            { value: "13", text: '13' },
            { value: "14", text: '14' },
            { value: "15", text: '15' },
            { value: "16", text: '16' },
            { value: "17", text: '17' },
            { value: "18", text: '18 (common)' },
          ],

          addressesFields: [
            { key: 'number', label: '#', sortable: false, thStyle: 'width: 5%;', tdClass: 'text-truncate' },
            { key: 'type', label: 'Type', sortable: false, thStyle: 'width: 15%;', thClass: 'text-left', tdClass: 'text-left' },
            { key: 'address', label: 'Address', sortable: false, thStyle: 'width: 40%;', thClass: 'text-left', tdClass: 'text-truncate' },
            { key: 'name', label: 'Name', sortable: false, thStyle: 'width: 40%;', thClass: 'text-left', tdClass: 'text-truncate' },
          ],

          reportingDateTimeOptions: [
            { value: 0, text: 'Local Time' },
            { value: 1, text: 'UTC Time' },
          ],
        },

        // --- COMPUTED ---
        computed: {

          explorer() {
            return this.chainId && this.chains[this.chainId] && this.chains[this.chainId].explorer;
          },

          chainsOptions() {
            const results = [];
            for (const [chainId, data] of Object.entries(this.chains)) {
              results.push({ value: chainId, text: data.name });
            }
            results.sort((a, b) => ('' + a.text).localeCompare(b.text));
            return results;
          },
          chainsOptionsWithSelect() {
            return [ { value: null, text: "(Select Chain)" }, ...this.chainsOptions ];
          },

          walletsOptions() {
            const results = [];
            results.push({ value: null, text: "(Select Wallet)" });
            for (const [address, data] of Object.entries(this.addresses)) {
              if (data.type == "wallet" && this.chainId && data.chains.includes(this.chainId.toString())) {
                results.push({ value: address, text: (data.name ? (data.name + ": ") : "") + address.substring(0, 8) + '...' + address.slice(-6) });
              }
            }
            return results;
          },

          tokensOptions() {
            const results = [];
            results.push({ value: null, text: "(Select Token)" });
            for (const [address, data] of Object.entries(this.addresses)) {
              if (data.type.substring(0, 3) == "erc" && this.chainId && data.chains.includes(this.chainId.toString())) {
                results.push({ value: address, text: (data.name ? (data.name + ": ") : "") + address.substring(0, 8) + '...' + address.slice(-6) });
              }
            }
            return results;
          },

          addressesOptions() {
            const results = [];
            results.push({ value: null, text: "(Select Address)" });
            for (const [address, data] of Object.entries(this.addresses)) {
              if (this.chainId && data.chains.includes(this.chainId.toString())) {
                results.push({ value: address, text: (data.name ? (data.name + ": ") : "") + address.substring(0, 8) + '...' + address.slice(-6) });
              }
            }
            return results;
          },

          filteredAddresses() {
            console.log(moment().format("HH:mm:ss") + " filteredAddresses: " + JSON.stringify(this.addresses));
            // let results = this.forceRefresh % 2 == 0 ? [] : [];
            const results = [];
            for (const [address, data] of Object.entries(this.addresses)) {
              results.push({
                address,
                type: data.type,
                ensName: data.ensName,
                name: data.name,
                symbol: data.symbol,
                decimals: data.decimals,
                chains: data.chains,
              });
            }
            return results;
          },
          filteredSortedAddresses() {
            let results = this.filteredAddresses;
          //   if (this.settings.accountsTable.sortOption == 'typenameasc') {
          //     results.sort((a, b) => {
          //       const typeA = a.customType || a.type;
          //       const typeB = b.customType || b.type;
          //       const sortIndexA = this.accountTypeOptions.findIndex(e => e.value == typeA);
          //       const sortIndexB = this.accountTypeOptions.findIndex(e => e.value == typeB);
          //       if (sortIndexA == sortIndexB) {
          //         const namea = a.customName || a.name;
          //         const nameb = b.customName || b.name;
          //         return ('' + namea).localeCompare(nameb);
          //       } else {
          //         return sortIndexA - sortIndexB;
          //       }
          //     });
          //   } else if (this.settings.accountsTable.sortOption == 'typenamedsc') {
          //     results.sort((a, b) => {
          //       const typeA = a.customType || a.type;
          //       const typeB = b.customType || b.type;
          //       const sortIndexA = this.accountTypeOptions.findIndex(e => e.value == typeA);
          //       const sortIndexB = this.accountTypeOptions.findIndex(e => e.value == typeB);
          //       if (sortIndexA == sortIndexB) {
          //         const namea = a.customName || a.name;
          //         const nameb = b.customName || b.name;
          //         return ('' + nameb).localeCompare(namea);
          //       } else {
          //         return sortIndexB - sortIndexA;
          //       }
          //     });
          //   } else if (this.settings.accountsTable.sortOption == 'nameasc') {
          //     results.sort((a, b) => {
          //       return ('' + a.name).localeCompare(b.name);
          //     });
          //   } else if (this.settings.accountsTable.sortOption == 'namedsc') {
          //     results.sort((a, b) => {
          //       return ('' + b.name).localeCompare(a.name);
          //     });
          //   } else if (this.settings.accountsTable.sortOption == 'addressasc') {
          //     results.sort((a, b) => {
          //       return ('' + a.address).localeCompare(b.address);
          //     });
          //   } else if (this.settings.accountsTable.sortOption == 'addressdsc') {
          //     results.sort((a, b) => {
          //       return ('' + b.address).localeCompare(a.address);
          //     });
          //   }
            return results;
          },
          pagedFilteredSortedAddresses() {
            console.log(moment().format("HH:mm:ss") + " pagedFilteredSortedAddresses - results[0..9]: " + JSON.stringify(this.filteredSortedAddresses.slice(0, 10), null, 2));
            return this.filteredSortedAddresses.slice((this.settings.addressesTable.currentPage - 1) * this.settings.addressesTable.pageSize, this.settings.addressesTable.currentPage * this.settings.addressesTable.pageSize);
          },
        },

        // --- METHODS ---
        methods: {

          showNewAddress() {
            console.log(moment().format("HH:mm:ss") + " showNewAddress");
            this.address.type = null;
            this.address.mode = 'add';
            this.address.address = null;
            this.address.ensName = null;
            this.address.name = null;
            this.address.symbol = null;
            this.address.decimals = null;
            this.address.chains = [ parseInt(this.chainId).toString() ];
            this.$bvModal.show('modal-address');
          },

          addressesRowSelected(item) {
            console.log(moment().format("HH:mm:ss") + " addressesRowSelected: " + JSON.stringify(item));
            if (item && item.length > 0) {
              this.address.mode = 'vieworupdate';
              this.address.type = item[0].type;
              this.address.address = item[0].address;
              this.address.ensName = item[0].ensName;
              this.address.name = item[0].name;
              this.address.symbol = item[0].symbol;
              this.address.decimals = item[0].decimals;
              this.address.chains = item[0].chains;
              this.$refs.addressesTable.clearSelected();
            }
            this.$bvModal.show('modal-address');
          },

          newWalletRecompute() {
            console.log(moment().format("HH:mm:ss") + " newWalletRecompute: " + JSON.stringify(this.newWallet));
            if (this.address.address) {
              try {
                const address = ethers.utils.getAddress(this.address.address);
                this.address.addressError = null;
                console.log(moment().format("HH:mm:ss") + " newWalletRecompute - AFTER: " + JSON.stringify(this.newWallet));
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " newWalletRecompute - ERROR: " + e.message);
                this.address.addressError = e.message;
              }
            } else {
              this.address.addressError = null;
            }
          },

          async addressRetrieveENS() {
            console.log(moment().format("HH:mm:ss") + " addressRetrieveENS - this.address: " + JSON.stringify(this.address, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const ensReverseRecordsContract = new ethers.Contract(ENSREVERSERECORDSADDRESS, ENSREVERSERECORDSABI, provider);
            try {
              const names = await ensReverseRecordsContract.getNames([this.address.address]);
              this.address.ensName = names.length == 1 && names[0] != "" ? names[0] : null;
              console.log(moment().format("HH:mm:ss") + " addressRetrieveENS - this.address.ensName: " + JSON.stringify(this.address.ensName, null, 2));
            } catch (e) {
              console.log("addressRetrieveENS - ensReverseRecordsContract.getNames ERROR: " + e.message);
            }
          },

          async addressRetrieveFromContract() {
            console.log(moment().format("HH:mm:ss") + " addressRetrieveFromContract - this.address: " + JSON.stringify(this.address, null, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            if (this.address.type.substring(0, 3) == "erc") {
              const erc721Contract = new ethers.Contract(this.address.address, ERC721ABI, provider);
              try {
                this.address.name = await erc721Contract.name();
              } catch (e) {
                console.log("addressRetrieveFromContract - erc721.name ERROR: " + e.message);
              }
              try {
                this.address.symbol = await erc721Contract.symbol();
              } catch (e) {
                console.log("addressRetrieveFromContract - erc721.symbol ERROR: " + e.message);
              }
            }
            if (this.address.type == "erc20") {
              const erc20Contract = new ethers.Contract(this.address.address, ERC20ABI, provider);
              try {
                this.address.decimals = ethers.BigNumber.from(await erc20Contract.decimals()).toString();
              } catch (e) {
                console.log("addressRetrieveFromContract - erc20.decimals ERROR: " + e.message);
              }
            }
            console.log(moment().format("HH:mm:ss") + " addressRetrieveFromContract - this.address AFTER: " + JSON.stringify(this.address, null, 2));
          },

          addressAdd() {
            Vue.set(this.addresses, this.address.address, {
              type: this.address.type,
              ensName: this.address.ensName,
              name: this.address.name,
              symbol: this.address.symbol,
              decimals: this.address.decimals,
              chains: this.address.chains,
            });
            localStorage.topSecretsOnlineAddresses = JSON.stringify(this.addresses);
            console.log(moment().format("HH:mm:ss") + " addressAdd - this.addresses: " + JSON.stringify(this.addresses, null, 2));
            this.$bvModal.hide('modal-address');
          },

          addressUpdate() {
            console.log(moment().format("HH:mm:ss") + " addressUpdate - this.address: " + JSON.stringify(this.address, null, 2));
            Vue.set(this.addresses[this.address.address], 'type', this.address.type);
            Vue.set(this.addresses[this.address.address], 'ensName', this.address.ensName);
            Vue.set(this.addresses[this.address.address], 'name', this.address.name);
            Vue.set(this.addresses[this.address.address], 'symbol', this.address.symbol);
            Vue.set(this.addresses[this.address.address], 'decimals', this.address.decimals);
            Vue.set(this.addresses[this.address.address], 'chains', this.address.chains);
            localStorage.topSecretsOnlineAddresses = JSON.stringify(this.addresses);
            console.log(moment().format("HH:mm:ss") + " addressUpdate - this.addresses: " + JSON.stringify(this.addresses, null, 2));
            this.$bvModal.hide('modal-address');
          },

          async addressDelete() {
            console.log(moment().format("HH:mm:ss") + " addressDelete - this.address: " + JSON.stringify(this.address, null, 2));
            this.$bvModal.msgBoxConfirm("Delete " + this.address.address + '?')
              .then(confirmed => {
                if (confirmed) {
                  Vue.delete(this.addresses, this.address.address);
                  localStorage.topSecretsOnlineAddresses = JSON.stringify(this.addresses);
                  console.log(moment().format("HH:mm:ss") + " addressDelete - this.addresses: " + JSON.stringify(this.addresses, null, 2));
                  this.$bvModal.hide('modal-address');
                }
              })
              .catch(err => {
              });
          },

          async prepareSimulate() {
            console.log(moment().format("HH:mm:ss") + " prepareSimulate: " + JSON.stringify(this.prepare, bigNumberReplacer, 2));

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            this.prepare.chainIdError = this.prepare.chainId != this.chainId && ("Warning - Web3 connected chain: " + this.chainsOptions.filter(e => e.value == this.chainId)[0].text) || null;
            const tokenInfo = this.prepare.token.address && this.addresses[this.prepare.token.address] || {};
            console.log("tokenInfo: " + JSON.stringify(tokenInfo, null, 2));
            // console.log("2: " + JSON.stringify(this.addresses[this.prepare.token.address].chains));
            if (this.prepare.token.address && tokenInfo.chains.includes(this.chainId.toString())) {
              this.prepare.token.name = tokenInfo.name;
              this.prepare.token.symbol = tokenInfo.symbol;
              this.prepare.token.decimals = tokenInfo.decimals;
              const tokenType = tokenInfo.type;
              if (tokenType == "erc20") {
                const contract = new ethers.Contract(this.prepare.token.address, ERC20ABI, provider);
                try {
                  this.prepare.token.totalSupply = ethers.BigNumber.from(await contract.totalSupply()).toString();
                } catch (e) {
                  console.log("prepareSimulate - erc20.totalSupply ERROR: " + e.message);
                  this.prepare.token.totalSupply = null;
                }
                if (this.prepare.from.address) {
                  try {
                    this.prepare.from.tokens = ethers.BigNumber.from(await contract.balanceOf(this.prepare.from.address)).toString();
                  } catch (e) {
                    console.log("prepareSimulate - erc20.balanceOf(from) ERROR: " + e.message);
                    this.prepare.from.tokens = null;
                  }
                }
                if (this.prepare.to.address) {
                  try {
                    this.prepare.to.tokens = ethers.BigNumber.from(await contract.balanceOf(this.prepare.to.address)).toString();
                  } catch (e) {
                    console.log("prepareSimulate - erc20.balanceOf(to) ERROR: " + e.message);
                    this.prepare.to.tokens = null;
                  }
                }
              } else if (tokenType == "erc721") {
                this.prepare.token.totalSupply = null;
                // TODO: need to get ERC-721 tokenIds
              }
            } else {
              this.prepare.token.name = null;
              this.prepare.token.symbol = null;
              this.prepare.token.decimals = null;
              this.prepare.token.totalSupply = null;
              this.prepare.from.tokens = null;
              this.prepare.to.tokens = null;
            }
            this.prepare.nonceError = null;
            if (this.prepare.from.address) {
              this.prepare.from.ensName = this.addresses[this.prepare.from.address].ensName;
              try {
                this.prepare.from.transactionCount = await provider.getTransactionCount(this.prepare.from.address);
                // this.prepare.nonce = this.prepare.from.transactionCount;
                // if (this.prepare.nonce != this.prepare.from.transactionCount)
                this.prepare.nonceError = this.prepare.nonce != this.prepare.from.transactionCount && ("Warning - Nonce <> from.transactionCount: " + this.prepare.from.transactionCount) || null;

              } catch (e) {
                this.prepare.from.transactionCount = null;
              }
              try {
                this.prepare.from.balance = await provider.getBalance(this.prepare.from.address);
              } catch (e) {
              }
            }
            if (this.prepare.to.address) {
              this.prepare.to.ensName = this.addresses[this.prepare.to.address].ensName;
              try {
                this.prepare.to.transactionCount = await provider.getTransactionCount(this.prepare.to.address);
              } catch (e) {
                this.prepare.to.transactionCount = null;
              }
              try {
                this.prepare.to.balance = await provider.getBalance(this.prepare.to.address);
              } catch (e) {
              }
            }

            if (this.prepare.from.address && this.prepare.to.address && this.prepare.amount) {
              const signer = new ethers.VoidSigner(this.prepare.from.address, provider);
              this.prepare.tx = null;
              if (this.prepare.token.address) {
                console.log(moment().format("HH:mm:ss") + " prepareSimulate - TOKEN");
                if (tokenInfo.chains.includes(this.chainId.toString()) && tokenInfo.type == "erc20") {
                  const contract = new ethers.Contract(this.prepare.token.address, ERC20ABI, provider);
                  console.table(contract);
                  const data = await contract.populateTransaction.transfer(this.prepare.to.address, ethers.utils.parseUnits(this.prepare.tokens, this.prepare.amountUnit).toString());
                  console.log("data: " + JSON.stringify(data, bigNumberReplacer, 2));
                  this.prepare.tx = {
                    from: this.prepare.from.address,
                    to: data.to,
                    // gasLimit: 50000,
                    // gasPrice: 1000000,
                    type: 2,
                    // maxFeePerGas: 1234000,
                    // maxPriorityFeePerGas: 1234000,
                    value: 0,
                    data: data.data,
                    nonce: this.prepare.nonce,
                    chainId: this.prepare.chainId,
                  };
                } else {
                  console.log(moment().format("HH:mm:ss") + " prepareSimulate - TOKEN ERROR: NOT SUPPORTED");
                }

              } else {
                console.log(moment().format("HH:mm:ss") + " prepareSimulate - REGULAR ETH TX");
                this.prepare.tx = {
                  from: this.prepare.from.address,
                  to: this.prepare.to.address,
                  // gasLimit: 50000,
                  // gasPrice: 1000000,
                  type: 2,
                  // maxFeePerGas: 1234000,
                  // maxPriorityFeePerGas: 1234000,
                  value: ethers.utils.parseUnits(this.prepare.amount, this.prepare.amountUnit).toString(),
                  data: null,
                  nonce: this.prepare.nonce,
                  chainId: this.prepare.chainId,
                };
              }
              console.log(moment().format("HH:mm:ss") + " prepareSimulate - this.prepare.tx: " + JSON.stringify(this.prepare.tx, bigNumberReplacer, 2));
              if (this.prepare.tx) {
                try {
                  this.prepare.estimatedGas = (await signer.estimateGas(this.prepare.tx)).toString();
                  console.log(moment().format("HH:mm:ss") + " prepareSimulate - estimatedGas: " + this.prepare.estimatedGas.toString());
                  this.prepare.error = null;
                } catch (e) {
                  console.log(moment().format("HH:mm:ss") + " prepareSimulate ERROR: " + e.message);
                  this.prepare.error = getError(e);
                  this.prepare.estimatedGas = null;
                }
                // const feeData = await provider.getFeeData();
                // this.prepare.lastBaseFeePerGas = ethers.utils.formatUnits(feeData.lastBaseFeePerGas.toString(), this.prepare.lastBaseFeePerGasUnit);
                // this.prepare.maxFeePerGas = ethers.utils.formatUnits(feeData.maxFeePerGas.toString(), this.prepare.maxFeePerGasUnit);
                // this.prepare.maxPriorityFeePerGas = ethers.utils.formatUnits(feeData.maxPriorityFeePerGas.toString(), this.prepare.maxPriorityFeePerGasUnit);
                // this.prepare.gasPrice = ethers.utils.formatUnits(feeData.gasPrice.toString(), this.prepare.gasPriceUnit);
                // this.prepare.lastBaseFeePerGas = feeData.lastBaseFeePerGas.toString();
                // this.prepare.maxFeePerGas = feeData.maxFeePerGas.toString();
                // this.prepare.maxPriorityFeePerGas = feeData.maxPriorityFeePerGas.toString();
                // this.prepare.gasPrice = feeData.gasPrice.toString();
              } else {
                this.prepare.estimatedGas = null;
              }
            }
            if (this.prepare.estimatedGas) {
              this.prepare.gasLimitError = (this.prepare.gasLimit == null || this.prepare.gasLimit < this.prepare.estimatedGas) && ("Warning - GasLimit < estimatedGas: " + this.prepare.estimatedGas) || null;
            } else {
              this.prepare.gasLimitError = null;
            }

            if (this.prepare.maxFeePerGas) {
              this.prepare.maxFeePerGasError = "Hah 1 + '" + this.prepare.maxFeePerGas + "'";
            } else {
              this.prepare.maxFeePerGasError = "Hah 2 + '" + this.prepare.maxFeePerGas + "'";
            }

            if (this.prepare.maxPriorityFeePerGas) {
              this.prepare.maxPriorityFeePerGasError = "Hoh 1 + '" + this.prepare.maxPriorityFeePerGas + "'";
            } else {
              this.prepare.maxPriorityFeePerGasError = "Hoh 2 + '" + this.prepare.maxPriorityFeePerGas + "'";
            }

            console.log(moment().format("HH:mm:ss") + " prepareSimulate - AFTER: " + JSON.stringify(this.prepare, bigNumberReplacer, 2));
            // this.saveSettings();
            localStorage.topSecretsOnlinePrepare = JSON.stringify(this.prepare);
          },

          submitCompare() {
            console.log(moment().format("HH:mm:ss") + " submitCompare - this.submit: " + JSON.stringify(this.submit, null, 2));
            if (this.submit.signedTx) {
              try {
                this.submit.decodedSignedTx = ethers.utils.parseTransaction(this.submit.signedTx);
                console.log("decoded: " + JSON.stringify(this.submit.decodedSignedTx, null, 2));
                console.log("this.prepare.from: " + this.prepare.from);
                console.log("this.submit.decodedSignedTx.from: " + this.submit.decodedSignedTx.from);
                this.submit.error = null;
                this.submit.from = this.submit.decodedSignedTx.from;
                this.submit.to = this.submit.decodedSignedTx.to;
                this.submit.amount = this.submit.decodedSignedTx.value.toString();
                this.submit.data = this.submit.decodedSignedTx.data == "0x" ? null : this.submit.decodedSignedTx.data;
                this.submit.chainId = parseInt(this.submit.decodedSignedTx.chainId || 0);
                this.submit.nonce = parseInt(this.submit.decodedSignedTx.nonce);
                this.submit.gasLimit = parseInt(this.submit.decodedSignedTx.gasLimit);
                this.submit.type = this.submit.decodedSignedTx.type && parseInt(this.submit.decodedSignedTx.type) || null;
                this.submit.gasPrice = !this.submit.decodedSignedTx.type ? this.submit.decodedSignedTx.gasPrice.toString() : null;
                this.submit.maxFeePerGas = this.submit.decodedSignedTx.type == 2 ? this.submit.decodedSignedTx.maxFeePerGas.toString() : null;
                this.submit.maxPriorityFeePerGas = this.submit.decodedSignedTx.type == 2 ? this.submit.decodedSignedTx.maxPriorityFeePerGas.toString() : null;
                console.log(moment().format("HH:mm:ss") + " submitCompare - this.submit AFTER: " + JSON.stringify(this.submit, null, 2));
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " submitCompare ERROR: " + e.message);
                this.submit.error = e.message;
              }
            } else {
              this.submit.error = null;
            }
            this.saveSettings();
          },

          async submitSimulate() {
            console.log(moment().format("HH:mm:ss") + " submitSimulate - this.submit: " + JSON.stringify(this.submit, bigNumberReplacer, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            if (this.submit.decodedSignedTx) {
              const signer = new ethers.VoidSigner(this.submit.decodedSignedTx.from, provider);
              console.table(signer);
              console.log(moment().format("HH:mm:ss") + " submitSimulate - this.submit.decodedSignedTx: " + JSON.stringify(this.submit.decodedSignedTx, bigNumberReplacer, 2));
              const tx = this.submit.decodedSignedTx;
              delete tx.hash;
              delete tx.v;
              delete tx.r;
              delete tx.s;
              console.log(moment().format("HH:mm:ss") + " submitSimulate - tx: " + JSON.stringify(tx, bigNumberReplacer, 2));
              try {
                const estimatedGas = (await signer.estimateGas(tx)).toString();
                console.log(moment().format("HH:mm:ss") + " submitSimulate - estimatedGas: " + estimatedGas.toString());
                // this.prepare.error = null;
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " submitSimulate ERROR: " + e.message);
                // this.prepare.error = e.message;
                // this.prepare.estimatedGas = null;
              }
            }
          },

          async submitSend() {
            console.log(moment().format("HH:mm:ss") + " submitSend - this.submit: " + JSON.stringify(this.submit, bigNumberReplacer, 2));
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            if (this.submit.signedTx) {
              // const signer = new ethers.VoidSigner(this.submit.decodedSignedTx.from, provider);
              // console.table(signer);
              // console.log(moment().format("HH:mm:ss") + " submitSend - this.submit.decodedSignedTx: " + JSON.stringify(this.submit.decodedSignedTx, null, 2));
              // const tx = this.submit.decodedSignedTx;
              // delete tx.hash;
              // delete tx.v;
              // delete tx.r;
              // delete tx.s;
              // console.log(moment().format("HH:mm:ss") + " submitSend - tx: " + JSON.stringify(tx, null, 2));
              try {
                const txResult = await provider.sendTransaction(this.submit.signedTx);
                console.log(moment().format("HH:mm:ss") + " submitSend - txResult: " + JSON.stringify(txResult, bigNumberReplacer, 2));
                // this.prepare.error = null;
              } catch (e) {
                console.log(moment().format("HH:mm:ss") + " submitSend ERROR: " + e.message);
                // this.prepare.error = e.message;
                // this.prepare.estimatedGas = null;
              }
            }
          },

          saveSettings() {
            // console.log(moment().format("HH:mm:ss") + " saveSettings: " + JSON.stringify(this.settings, bigNumberReplacer, 2));
            localStorage.topSecretsOnlineSettings = JSON.stringify(this.settings);
          },
          async processNewBlock(blockNumber) {
            const provider = new ethers.providers.Web3Provider(window.ethereum);

            this.feeData = await provider.getFeeData();
            console.log("this.feeData: " + JSON.stringify(this.feeData, bigNumberReplacer, 2));

            console.log(moment().format("HH:mm:ss") + " processNewBlock[" + this.chainId + "] #" + this.commify0(blockNumber) +
              ", latest #" + this.commify0(this.blockNumber) +
              " @ " + moment.unix(this.timestamp).format("YYYY-MM-DD HH:mm:ss") +
              " " + moment.unix(this.timestamp).fromNow() +
              ": " + ethers.utils.formatUnits(this.feeData.lastBaseFeePerGas, "gwei") +
              " - " + ethers.utils.formatUnits(this.feeData.maxFeePerGas, "gwei") +
              " + " + ethers.utils.formatUnits(this.feeData.maxPriorityFeePerGas, "gwei") +
              "; " + ethers.utils.formatUnits(this.feeData.gasPrice, "gwei") + " gwei");
          },
          async halt() {
            this.sync.halt = true;
            console.log(moment().format("HH:mm:ss") + " halt()");
          },
          commify0(n) {
            if (n != null) {
              return Number(n).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }
            return null;
          },
          formatETH(e, precision = 0) {
            try {
              if (precision == 0) {
                return e ? ethers.utils.formatEther(e).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") : null;
              } else {
                return e ? parseFloat(ethers.utils.formatEther(e)).toFixed(precision) : null;
              }
            } catch (err) {
            }
            return e.toFixed(precision);
          },
          formatUnits(e, u, precision = 0) {
            if (e) {
              if (precision == 0) {
                return ethers.utils.formatUnits(e, u).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
              } else {
                return e ? parseFloat(ethers.utils.formatUnits(e, u)).toFixed(precision) : null;
              }
            }
            return null;
          },
          formatGas(e) {
            try {
              return ethers.utils.formatUnits(e, "gwei");
            } catch (err) {
            }
            return e && e.toString() || "";
          },
          formatDecimals(e, decimals = 18) {
            return e ? ethers.utils.formatUnits(e, decimals) : null;
          },
          formatTimestamp(ts) {
            if (ts != null) {
              if (this.settings.reportingDateTime == 1) {
                return moment.unix(ts).utc().format("YYYY-MM-DD HH:mm:ss");
              } else {
                return moment.unix(ts).format("YYYY-MM-DD HH:mm:ss");
              }
            }
            return null;
          },
          formatTimeDiff(unixtime) {
            if (!unixtime) {
              return "";
            } else {
              return moment.unix(unixtime).fromNow();
            }
          },
          nameOrAddress(address, length = 0) {
            let result = null;
            // const accounts = this.accounts[this.chainId] || {};
            // if (address in accounts) {
            //   result = accounts[address].customName || accounts[address].name || address;
            // } else {
              result = address;
            // }
            if (result && length > 0) {
              result = result.substring(0, length);
            }
            return result;
          },
          copyToClipboard(str) {
            navigator.clipboard.writeText(str);
          },
          async connectToWeb3() {
            if (!window.ethereum) {
              this.connected = false;
            } else {
              try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.connected = window.ethereum.isConnected();
              } catch (e) {
                console.log("window.ethereum.request error: " + e.message);
                this.connected = false;
              }
            }
            if (!this.connected) {
              alert("Please use the https://metamask.io addon with Firefox, Chromium, Opera or Chrome, or any other other web3 browser, for web3 data retrieval. And refresh!");
            } else {
              const t = this;
              function handleChainChanged(_chainId) {
                t.chainId = parseInt(_chainId);
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleChainChanged - this.chainId: " + t.chainId);
                alert('Please reload this page as the chain has changed')
                // window.location.reload();
                // TODO: Block handling needs to be reset
                // provider.on("block", handleNewBlock);
                t.prepareSimulate();
              }
              window.ethereum.on('chainChanged', handleChainChanged);
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              async function handleAccountsChanged(accounts) {
                const signer = provider.getSigner();
                t.coinbase = await signer.getAddress();
                console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleAccountsChanged: " + t.coinbase);
              }
              window.ethereum.on('accountsChanged', handleAccountsChanged);
              async function handleNewBlock(blockNumber) {
                // console.log(moment().format("HH:mm:ss") + " connectToWeb3 - handleNewBlock - blockNumber: " + blockNumber);
                if (!t.blockNumber || blockNumber > t.blockNumber) {
                  const block = await provider.getBlock("latest");
                  t.blockNumber = block.number;
                  t.timestamp = block.timestamp;
                  await t.processNewBlock(blockNumber);
                }
              }
              provider.on("block", handleNewBlock);
              const signer = provider.getSigner();
              this.coinbase = await signer.getAddress();
              const network = await provider.getNetwork();
              this.chainId = parseInt(network.chainId);
              console.log(moment().format("HH:mm:ss") + " connectToWeb3[" + this.chainId + "]");
            }
          },
        },

        // --- MOUNTED ---
        mounted() {
          for (const [chainId, name] of Object.entries(CHAINS)) {
            if (!(chainId in this.chains)) {
              Vue.set(this.chains, chainId, name);
            }
          }
          // console.log("this.chains: " + JSON.stringify(this.chains, null, 2));
          (async() => {
            await this.connectToWeb3();
          })();
          if ('topSecretsOnlineChainId' in localStorage) {
            this.chainId = localStorage.topSecretsOnlineChainId;
          }
          if ('topSecretsOnlineCoinbase' in localStorage) {
            this.coinbase = localStorage.topSecretsOnlineCoinbase;
          }
          if ('topSecretsOnlineSettings' in localStorage) {
            const tempSettings = JSON.parse(localStorage.topSecretsOnlineSettings);
            if ('version' in tempSettings && tempSettings.version == this.settings.version) {
              this.settings = tempSettings;
              if (this.settings.addressesTable.currentPage > 1) {
                this.settings.addressesTable.currentPage = 1;
              }
              if ('topSecretsOnlineAddresses' in localStorage) {
                this.addresses = JSON.parse(localStorage.topSecretsOnlineAddresses);
              }
              if ('topSecretsOnlinePrepare' in localStorage) {
                this.prepare = JSON.parse(localStorage.topSecretsOnlinePrepare);
              }
            }
          }
        },
      })
    </script>
  </body>
</html>
